name: Update package repositories

on:
  push:
    branches:
      - main
    tags:
      - "*"

concurrency:
  group: split-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: read

env:
  PACKAGES_DIR: packages
  PUSH_ONLY_CHANGED_ON_MAIN: "true"

jobs:
  split:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ensure jq is available
        run: |
          if ! command -v jq >/dev/null 2>&1; then
            sudo apt-get update
            sudo apt-get install -y jq
          fi

      - name: Check ACCESS_TOKEN
        run: bin/gh-workflow/check_token.sh
        env:
          ACCESS_TOKEN: ${{ secrets.MONOREPO_SPLITTING_TOKEN }}

      - name: Discover packages and build mapping
        id: discover
        shell: bash
        run: |
          bin/gh-workflow/discover_packages.sh "${{ github.repository_owner }}" "${PACKAGES_DIR}" > /tmp/packages.json
          echo "Discovered packages:"
          cat /tmp/packages.json | jq -r '.[] | "- \(.path) -> \(.repo) (branch: \(.default_branch))"'
          echo "packages_json=$(cat /tmp/packages.json)" >> "$GITHUB_OUTPUT"

      - name: Determine packages to push
        id: plan
        shell: bash
        run: |
          PACKAGES_JSON_PATH=/tmp/packages.json
          if [ ! -s "$PACKAGES_JSON_PATH" ] || [ "$(jq 'length' "$PACKAGES_JSON_PATH")" -eq 0 ]; then
            echo "::warning::No packages to process."
            echo "none=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          
          #          BEFORE="${{ github.event.before || '-' }}"
          BEFORE="-"
          bin/gh-workflow/plan_packages.sh "${GITHUB_REF_TYPE}" "$BEFORE" "${GITHUB_SHA}" "$PACKAGES_JSON_PATH" > /tmp/selected.json

          if [ "$(jq 'length' /tmp/selected.json)" -eq 0 ]; then
            echo "none=true" >> "$GITHUB_OUTPUT"
            echo "Selected packages: (none)"
          else
            echo "none=false" >> "$GITHUB_OUTPUT"
            echo "selected=$(cat /tmp/selected.json)" >> "$GITHUB_OUTPUT"
            echo "Selected packages:"
            cat /tmp/selected.json | jq -r '.[] | "- \(.path) -> \(.repo)"'
          fi

      - name: Split & push
        if: steps.plan.outputs.none == 'false'
        shell: bash
        env:
          ACCESS_TOKEN: ${{ secrets.MONOREPO_SPLITTING_TOKEN }}
        run: |
          GIT_AUTHOR_NAME="Alex Brouwer"
          GIT_AUTHOR_EMAIL="brouwer.alexander@Gmail.com"
          TAG_NAME="${GITHUB_REF##*/}"
          bin/gh-workflow/split_and_push.sh /tmp/selected.json "${GITHUB_REF_TYPE}" "$TAG_NAME" "${GITHUB_SHA}"

      - name: Summary
        if: always()
        run: |
          echo "Ref: $GITHUB_REF ($GITHUB_REF_TYPE) @ $GITHUB_SHA"
          echo "Done."
